<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
  <meta charset="utf-8" />
  <title>{{ lang.ai_chatbot }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="fixed top-0 left-0 h-full w-60 bg-green-700 text-white shadow-xl">
    <div class="p-5 text-2xl font-bold border-b border-green-500">{{ lang.app_title }}</div>
    <nav class="mt-4">
      <a href="/dashboard.html?lang={{ current_lang }}" class="block p-4 hover:bg-green-600">ğŸ“Š {{ lang.dashboard }}</a>
      <a href="/crop_recommendation.html?lang={{ current_lang }}" class="block p-4 hover:bg-green-600">ğŸŒ± {{ lang.crop_recommendation }}</a>
      <a href="/disease_detection.html?lang={{ current_lang }}" class="block p-4 hover:bg-green-600">ğŸ¦  {{ lang.disease_detection }}</a>
      <a href="/fertilizer_advisory.html?lang={{ current_lang }}" class="block p-4 hover:bg-green-600">ğŸ§ª {{ lang.fertilizer_advisory }}</a>
      <a href="/ai_interactive.html?lang={{ current_lang }}" class="block p-4 bg-green-600">ğŸ¤– {{ lang.ai_chatbot }}</a>
      <a href="/weather.html?lang={{ current_lang }}" class="block p-4 hover:bg-green-600">â˜ {{ lang.weather }}</a>
       <div class="p-4 mt-3">
        <label class="block mb-2 font-semibold">ğŸŒ {{ lang.language }}</label>
        <select id="lang" class="p-2 w-full text-black rounded">
          <option value="en">English</option>
          <option value="hi">Hindi</option>
          <option value="te">Telugu</option>
        </select>
      </div>
    </nav>
     <div class="absolute bottom-4 w-full text-center text-sm p-2">
      <p>Developed_by <b>vss</b><br>Â© 2025</p>
    </div>
  </div>

  <main class="ml-60 p-8">
    <h1 class="text-3xl font-bold mb-4">{{ lang.ai_chatbot }}</h1>

    <div class="max-w-3xl">
      <div id="chat-container" class="bg-gray-200 p-4 rounded shadow h-96 overflow-y-auto mb-4 flex flex-col space-y-3">
        <div class="text-center text-gray-500 text-sm mt-2">Start the conversation...</div>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <label class="block font-semibold mb-2">{{ lang.chat_label }}</label>
        <div class="flex gap-2">
          <input id="message" class="w-full border p-2 rounded" placeholder="..." />
          <button id="send" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">{{ lang.chat_btn }}</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const CURRENT_LANGUAGE = '{{ current_lang }}';
    const langQueryParam = `?lang=${CURRENT_LANGUAGE}`;
    const chatContainer = document.getElementById('chat-container');

    // Language Switcher
    const langSelect = document.getElementById('lang');
    if (langSelect) {
      langSelect.value = CURRENT_LANGUAGE;
      langSelect.addEventListener('change', (e) => {
        const newLang = e.target.value;
        window.location.search = `?lang=${newLang}`;
      });
    }
    
    // Format AI Text (Bold, Newlines, Bullets)
    function formatAIResponse(text) {
      if (!text) return "";
      return text
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/^\s*(\d+\.|\-|\â€”|\*)\s+/gm, '<br/>â€¢ ')
        .replace(/\n/g, '<br/>');
    }

    // Function to append messages to the chat window
    function appendMessage(role, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = "p-3 rounded-lg max-w-[80%] break-words shadow text-sm";
      
      if (role === 'user') {
        // User styling: Right side, Blue background
        msgDiv.classList.add('bg-blue-600', 'text-white', 'self-end');
        msgDiv.innerHTML = text;
      } else {
        // Bot styling: Left side, White background
        msgDiv.classList.add('bg-white', 'text-gray-800', 'self-start');
        msgDiv.innerHTML = `<b>{{ lang.chat_bot_label }}:</b><br/>` + formatAIResponse(text);
      }
      
      chatContainer.appendChild(msgDiv);
      // Auto-scroll to bottom
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
      const msgInput = document.getElementById('message');
      const msg = msgInput.value.trim();
      if (!msg) return alert('Write a question');
      
      // 1. Show User Message
      appendMessage('user', msg);
      msgInput.value = ''; // Clear input

      // 2. Show "Thinking..." indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = "p-2 text-gray-500 text-xs self-start italic";
      loadingDiv.innerText = "Thinking...";
      chatContainer.appendChild(loadingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        // 3. Call API
        const res = await fetch(`/api/chat${langQueryParam}`, {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({message: msg})
        });
        const json = await res.json();
        
        // Remove "Thinking..."
        chatContainer.removeChild(loadingDiv);

        if (json.error) {
          appendMessage('bot', `Error: ${json.error}`);
        } else {
          // 4. Show Bot Response
          const responseText = json.response || "No response found.";
          appendMessage('bot', responseText);
        }
      } catch (e) {
        chatContainer.removeChild(loadingDiv);
        appendMessage('bot', "Network or server error. Please try again.");
      }
    }

    // Send on Click
    document.getElementById('send').addEventListener('click', sendMessage);

    // Send on Enter Key
    document.getElementById('message').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>